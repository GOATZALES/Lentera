{% extends 'base_planning.html' %}
{% load static %}
{% load planning_extras %} {# Muat custom templatetag #}

{% block title %}Detail Forecast {{ forecast_log_id }} - Faskes {{ faskes_id }}{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <!-- <link rel="stylesheet" href="{% static 'planning/css/planning_detail.css' %}"> -->
    <style>
        .planning-container { padding: 32px; }
        .planning-card {
            background: white; border-radius: 12px; padding: 24px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08); margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }
        .planning-card h3, .planning-card h4 { color: #1e293b; font-weight: 600; margin-bottom: 1rem; }
        .planning-card h3 { font-size: 1.5rem; }
        .planning-card h4 { font-size: 1.1rem; }
        .planning-card p, .planning-card ul li { color: #475569; margin-bottom: 0.5rem; }
        .planning-card ul { list-style-type: none; padding-left: 0; }
        .planning-form-label { font-size: 14px; font-weight: 600; color: #374151; margin-bottom: .5rem; display: block; }
        .planning-form-control {
            display: block; width: 100%; padding: .75rem 1rem; font-size: 14px;
            border: 2px solid #e5e7eb; border-radius: 8px;
        }
        .planning-form-control:focus { border-color: #4facfe; outline: 0; box-shadow: 0 0 0 3px rgba(79,172,254,0.1); }
        .planning-btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;
            padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600;
        }
        .planning-btn-secondary {
            background: #f1f5f9; color: #64748b;
            padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600;
        }
         .alert-planning { padding: 12px 16px; border-radius: 8px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .alert-planning.danger { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .alert-planning.warning { background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }
        .feedback-icon { color: #4facfe; margin-right: 8px; }
    </style>
{% endblock %}

{% block content_planning %}
<div class="planning-container">
    <div class="profile-header" style="text-align: center; margin-bottom: 30px;">
        <h1 class="profile-name" style="font-size: 24px;">Detail Forecast (ID Log AI: {{ forecast_log_id }})</h1>
    </div>

    {% if error_message %}
        <div class="alert-planning danger">{{ error_message }}</div>
    {% elif not forecast_detail %}
        <p class="text-center">Data forecast tidak ditemukan.</p>
    {% else %}
        <div class="planning-card">
            <h3>Informasi Permintaan</h3>
            <p><strong>Faskes ID:</strong> {{ forecast_detail.caller_reference_id }}</p>
            <p><strong>Periode:</strong> {{ forecast_detail.input_payload_json.period_start }} s/d {{ forecast_detail.input_payload_json.period_end }}</p>
            <p><strong>Diminta Pada:</strong> {{ forecast_detail.requested_at|date:"d M Y, H:i" }}</p>
            <p><strong>Model AI:</strong> {{ forecast_detail.ai_model_name_used|default:"N/A" }}</p>
        </div>

        <div class="planning-card">
            <h3><i class="fas fa-brain feedback-icon"></i>Hasil Prediksi AI</h3>
            {% if forecast_detail.parsed_ai_output_json %}
                <h4>Kebutuhan Staf:</h4>
                <ul>
                    {% for role, count in forecast_detail.parsed_ai_output_json.predicted_staffing_demand.items %}
                        <li><strong>{{ role }}:</strong> {{ count }}</li>
                    {% empty %}
                        <li>Tidak ada prediksi staf.</li>
                    {% endfor %}
                </ul>
                <h4>Estimasi Biaya (Rp):</h4>
                <p>
                    Min: {{ forecast_detail.parsed_ai_output_json.estimated_cost_range_rp.min_cost|floatformat:0|default:"N/A" }} - 
                    Max: {{ forecast_detail.parsed_ai_output_json.estimated_cost_range_rp.max_cost|floatformat:0|default:"N/A" }}
                </p>
                <h4>Alert & Rekomendasi:</h4>
                <p>{{ forecast_detail.parsed_ai_output_json.peak_period_alerts_and_recommendations|default:"Tidak ada."|linebreaksbr }}</p>
            {% else %}
                <p class="text-warning">Output AI tidak tersedia atau gagal diparsing.</p>
            {% endif %}
        </div>
        
        <div class="planning-card">
            <h3><i class="fas fa-clipboard-check feedback-icon"></i>Feedback & Data Aktual (Recommendation Tracking)</h3>
            {% with feedback=forecast_detail.feedback_info %}
                {% if feedback and feedback.feedback_log_id %}
                    <p><strong>Feedback Terakhir Diberikan:</strong> {{ feedback.feedback_provided_at|date:"d M Y, H:i" }}</p>
                    <h4>Data Aktual yang Dilaporkan:</h4>
                    {% if feedback.actual_data_json.staffing %}
                    <ul>
                        {% for role, count in feedback.actual_data_json.staffing.items %}
                            <li><strong>{{ role }}:</strong> {{ count }}</li>
                        {% empty %}
                             <li>Belum ada data aktual staffing.</li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p>Belum ada data aktual staffing yang dilaporkan.</p>
                    {% endif %}

                    <h4>Skor Akurasi:</h4>
                    <p><strong>Keseluruhan:</strong> {{ feedback.overall_accuracy_score|default_if_none:"N/A" }}%</p>
                    {% if feedback.accuracy_metrics_json and feedback.accuracy_metrics_json.error is None %}
                        <h5>Detail per Role:</h5>
                        <ul>
                        {% for role, metrics in feedback.accuracy_metrics_json.items %}
                            <li><strong>{{ role }}:</strong> 
                                Prediksi={{ metrics.predicted|default_if_none:0 }}, Aktual={{ metrics.actual|default_if_none:0 }}. 
                                {% if metrics.mape_percent is not None %}MAPE={{ metrics.mape_percent }}%{% endif %}
                            </li>
                        {% endfor %}
                        </ul>
                    {% elif feedback.accuracy_metrics_json.error %}
                        <p class="text-danger">Error perhitungan akurasi: {{ feedback.accuracy_metrics_json.error }}</p>
                    {% endif %}
                    <p><strong>Catatan Feedback:</strong> {{ feedback.qualitative_feedback|default:"Tidak ada catatan."|linebreaksbr }}</p>
                    <hr>
                    <p>Anda bisa memperbarui feedback di bawah ini:</p>
                {% else %}
                    <p>Belum ada feedback yang diberikan untuk forecast ini.</p>
                {% endif %}
            {% endwith %}

            <h4 class="mt-3">Form Input Data Aktual & Feedback</h4>
            <form method="POST" action="{% url 'planning:submit_actual_data' forecast_log_id=forecast_log_id %}">
                {% csrf_token %}
                <p>Masukkan jumlah staf aktual untuk periode forecast ini:</p>
                {% if forecast_detail.parsed_ai_output_json.predicted_staffing_demand %}
                    {% for role, predicted_count in forecast_detail.parsed_ai_output_json.predicted_staffing_demand.items %}
                        <div class="row mb-2 align-items-center">
                            <label for="actual_{{ role|safe_slugify }}" class="col-sm-4 col-md-3 planning-form-label">Aktual {{ role }}:</label>
                            <div class="col-sm-8 col-md-4">
                                <input type="number" class="planning-form-control form-control-sm" 
                                    id="actual_{{ role|safe_slugify }}"
                                    name="actual_{{ role|safe_slugify }}" {# Nama field harus konsisten dengan view #}
                                    value="{{ actual_staffing_json_for_template|get_item:role|default_if_none:'' }}" 
                                    min="0" placeholder="Prediksi: {{ predicted_count }}">
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">Tidak ada prediksi staf dari AI untuk dijadikan acuan input.</p>
                {% endif %}
                
                <div class="mt-3">
                    <label for="qualitative_feedback" class="planning-form-label">Catatan Feedback Kualitatif (Opsional):</label>
                    <textarea class="planning-form-control" id="qualitative_feedback" name="qualitative_feedback" rows="3">{{ qualitative_feedback_for_template }}</textarea>
                    <small class="form-text text-muted">Misalnya: "Prediksi dokter umum cukup akurat, tapi perawat kurang dari kebutuhan sebenarnya."</small>
                </div>
                <button type="submit" class="btn planning-btn-success mt-3"><i class="fas fa-paper-plane"></i> Kirim Data Aktual & Feedback</button>
            </form>
        </div>
    {% endif %} {# end if forecast_detail #}
    <hr>
    <a href="{% url 'planning:dashboard' %}" class="btn planning-btn-secondary mt-3"><i class="fas fa-arrow-left"></i> Kembali ke Dashboard</a>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Untuk prefill form feedback jika data sudah ada
    const actualStaffingJson = '{{ actual_staffing_json_for_template|safe|escapejs }}';
    try {
        const actualStaffingData = JSON.parse(actualStaffingJson);
        for (const role in actualStaffingData) {
            if (actualStaffingData.hasOwnProperty(role)) {
                // Perlu slugify role agar cocok dengan ID/name elemen input
                // Fungsi slugify sederhana, bisa disesuaikan atau pakai dari Django di view
                const slugRole = role.toLowerCase()
                                     .replace(/\s+/g, '_')       // Ganti spasi dengan _
                                     .replace(/[^\w-]+/g, ''); // Hapus karakter non-alphanumeric kecuali _ dan -
                const inputElement = document.getElementById('actual_' + slugRole) || document.getElementsByName('actual_' + slugRole)[0];
                if (inputElement) {
                    inputElement.value = actualStaffingData[role];
                } else {
                    // console.warn("Input element not found for role:", role, " Slug:", 'actual_' + slugRole);
                }
            }
        }
    } catch(e) {
        console.error("Error parsing actual_staffing_json_for_template for prefill:", e, actualStaffingJson);
    }
});
</script>
{% endblock %}